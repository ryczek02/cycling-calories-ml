<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Kalorii Kolarskich</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-main: #212529;
            --text-muted: #6c757d;
            --border-radius: 12px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 8px 30px rgba(0,0,0,0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            padding: 40px 0;
            -webkit-font-smoothing: antialiased;
        }

        .container-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header Styles */
        .header {
            text-align: center;
            margin-bottom: 60px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--text-muted);
            font-weight: 300;
        }

        /* Card Styles */
        .app-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid rgba(0,0,0,0.05);
            padding: 40px;
            box-shadow: var(--shadow-md);
            margin-bottom: 40px;
            transition: transform 0.2s ease;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--primary-color);
            border-bottom: 2px solid #f1f3f5;
            padding-bottom: 10px;
            display: inline-block;
        }

        /* Form Styles */
        .form-label {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-main);
            margin-bottom: 8px;
        }

        .form-control {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-control:focus {
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
            border-color: var(--accent-color);
        }

        .btn-upload {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            width: 100%;
            height: 100%; /* Align with inputs */
            transition: background-color 0.2s;
        }

        .btn-upload:hover {
            background-color: #1a252f;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading p {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 15px;
        }

        /* Results Section */
        .results-section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Calorie Display */
        .calorie-display {
            text-align: center;
            padding: 40px;
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
            margin-bottom: 40px;
        }

        .calorie-label {
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .calorie-value {
            font-size: 4rem;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1;
        }

        .calorie-unit {
            font-size: 1.5rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* Map */
        #map {
            height: 500px;
            width: 100%;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            z-index: 1;
        }

        .legend-container {
            background: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 40px;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-item {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #f1f3f5;
            transition: box-shadow 0.2s;
        }

        .stat-item:hover {
            box-shadow: var(--shadow-sm);
            border-color: #dee2e6;
        }

        .stat-icon {
            font-size: 1.2rem;
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-unit {
            font-size: 0.9rem;
            font-weight: 400;
            color: var(--text-muted);
            margin-left: 2px;
        }

        /* Charts */
        .chart-wrapper {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #f1f3f5;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .chart-wrapper h5 {
            font-size: 1rem;
            color: var(--text-main);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .chart-wrapper img {
            width: 100%;
            height: auto;
            border-radius: 4px;
        }

        /* Custom Markers for Map */
        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.3);
        }

        .marker-pin::after {
            content: '';
            width: 14px;
            height: 14px;
            margin: 8px 0 0 8px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }

        .custom-div-icon {
            background: transparent;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container-main">
        <div class="header">
            <p>Wgraj plik GPX, aby otrzymać predykcję wydatku energetycznego</p>
        </div>

        <div class="app-card">
            <h3 class="section-title">Dane wejściowe</h3>
            <form id="uploadForm">
                <div class="row g-4 align-items-end">
                    <div class="col-md-5">
                        <label for="gpxFile" class="form-label">Plik trasy (GPX)</label>
                        <input type="file" class="form-control" id="gpxFile" accept=".gpx" required>
                    </div>
                    <div class="col-md-4">
                        <label for="weight" class="form-label">Waga zawodnika (kg)</label>
                        <input type="number" class="form-control" id="weight" value="75" min="40" max="150" step="0.5" required>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-upload">
                            <i class="bi bi-graph-up-arrow me-2"></i> Analizuj
                        </button>
                    </div>
                </div>
            </form>

            <div class="loading" id="loading">
                <div class="spinner-border text-secondary" role="status">
                    <span class="visually-hidden">Ładowanie...</span>
                </div>
                <p>Przetwarzanie danych telemetrycznych...</p>
            </div>
        </div>

        <div id="results" class="results-section">
            <div class="calorie-display">
                <div class="calorie-label">Szacowany wydatek energetyczny</div>
                <div>
                    <span id="calorieValue" class="calorie-value">0</span>
                    <span class="calorie-unit">kcal</span>
                </div>
            </div>

            <div class="stats-grid" id="statsContainer">
                </div>

            <div class="app-card">
                <h3 class="section-title">Analiza wizualna trasy</h3>
                <div id="map"></div>
                
                <div class="legend-container">
                    <div class="legend-item">
                        <span class="legend-dot" style="background-color: #d73027;"></span>
                        <span>Niska (0-15 km/h)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background-color: #fee08b;"></span>
                        <span>Średnia (15-25 km/h)</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background-color: #1a9850;"></span>
                        <span>Wysoka (25+ km/h)</span>
                    </div>
                </div>
            </div>

            <div class="app-card">
                <h3 class="section-title">Szczegółowe wykresy</h3>
                <div id="chartsContainer" class="row">
                    </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let map = null;

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const fileInput = document.getElementById('gpxFile');
            const weightInput = document.getElementById('weight');

            if (!fileInput.files[0]) {
                alert('Proszę wybrać plik GPX.');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('weight', weightInput.value);

            // UI Feedback
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Błąd przetwarzania pliku');
                }

                const data = await response.json();
                displayResults(data);

            } catch (error) {
                alert('Wystąpił błąd: ' + error.message);
                console.error(error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        });

        function displayResults(data) {
            document.getElementById('results').style.display = 'block';
            
            // Animacja licznika kalorii
            animateValue("calorieValue", 0, Math.round(data.predicted_calories), 1000);

            displayMap(data.route_points);
            displayStats(data.route_summary, data.athlete_weight);
            displayCharts(data.charts);

            // Płynne przewijanie
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Prosta funkcja animująca liczby
        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        function displayMap(routePoints) {
            if (!routePoints || routePoints.length === 0) return;

            if (map) map.remove();

            map = L.map('map').setView([0, 0], 13);

            // Nowoczesna warstwa mapy (CartoDB Positron - czysta i jasna)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            const latLngs = [];

            for (let i = 0; i < routePoints.length - 1; i++) {
                const point = routePoints[i];
                const nextPoint = routePoints[i + 1];

                latLngs.push([point.lat, point.lon]);

                const speed = point.speed;
                let color;
                if (speed < 15) color = '#d73027';
                else if (speed < 25) color = '#fee08b';
                else color = '#1a9850';

                L.polyline(
                    [[point.lat, point.lon], [nextPoint.lat, nextPoint.lon]],
                    { color: color, weight: 4, opacity: 0.8 }
                ).addTo(map).bindPopup(`
                    <div style="font-family: sans-serif; font-size: 12px;">
                        <b>Dystans:</b> ${point.distance.toFixed(2)} km<br>
                        <b>Prędkość:</b> ${speed.toFixed(1)} km/h<br>
                        <b>Wysokość:</b> ${point.elevation.toFixed(0)} m
                    </div>
                `);
            }

            if (routePoints.length > 0) {
                const lastPoint = routePoints[routePoints.length - 1];
                latLngs.push([lastPoint.lat, lastPoint.lon]);

                // Stylowe markery CSS zamiast HTML z emoji
                const createPin = (color) => {
                    return L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: ${color}" class="marker-pin"></div>`,
                        iconSize: [30, 42],
                        iconAnchor: [15, 42]
                    });
                };

                L.marker([routePoints[0].lat, routePoints[0].lon], { icon: createPin('#198754') }) // Zielony
                    .addTo(map).bindPopup('<b>Start</b>');

                L.marker([lastPoint.lat, lastPoint.lon], { icon: createPin('#dc3545') }) // Czerwony
                    .addTo(map).bindPopup('<b>Meta</b>');
            }

            if (latLngs.length > 0) map.fitBounds(latLngs, { padding: [50, 50] });
        }

        function displayStats(summary, weight) {
            const statsContainer = document.getElementById('statsContainer');

            // Mapowanie ikon Bootstrap Icons
            const stats = [
                { label: 'Dystans całkowity', value: summary.distance_km.toFixed(2), unit: 'km', icon: 'bi-geo-alt' },
                { label: 'Suma przewyższeń', value: Math.round(summary.elevation_gain), unit: 'm', icon: 'bi-arrow-up-right' },
                { label: 'Suma zjazdów', value: Math.round(summary.elevation_loss), unit: 'm', icon: 'bi-arrow-down-right' },
                { label: 'Czas trwania', value: Math.round(summary.total_time_min), unit: 'min', icon: 'bi-stopwatch' },
                { label: 'Średnia prędkość', value: summary.avg_speed.toFixed(1), unit: 'km/h', icon: 'bi-speedometer2' },
                { label: 'Max prędkość', value: summary.max_speed.toFixed(1), unit: 'km/h', icon: 'bi-lightning-charge' },
                { label: 'Średnie nachylenie', value: summary.avg_grade.toFixed(2), unit: '%', icon: 'bi-activity' },
                { label: 'Waga zawodnika', value: weight.toFixed(1), unit: 'kg', icon: 'bi-person' },
            ];

            statsContainer.innerHTML = stats.map(stat => `
                <div class="stat-item">
                    <div class="stat-icon"><i class="bi ${stat.icon}"></i></div>
                    <div class="stat-label">${stat.label}</div>
                    <div>
                        <span class="stat-value">${stat.value}</span>
                        <span class="stat-unit">${stat.unit}</span>
                    </div>
                </div>
            `).join('');
        }

        function displayCharts(charts) {
            const chartsContainer = document.getElementById('chartsContainer');
            let chartsHtml = '';

            const createChartCard = (title, src) => `
                <div class="col-md-4 mb-3">
                    <div class="chart-wrapper">
                        <h5>${title}</h5>
                        <img src="${src}" alt="${title}" loading="lazy">
                    </div>
                </div>
            `;

            if (charts.elevation_profile) chartsHtml += createChartCard('Profil wysokościowy', charts.elevation_profile);
            if (charts.speed_profile) chartsHtml += createChartCard('Wykres prędkości', charts.speed_profile);
            if (charts.grade_histogram) chartsHtml += createChartCard('Rozkład nachylenia', charts.grade_histogram);

            chartsContainer.innerHTML = chartsHtml;
        }
    </script>
</body>
</html>